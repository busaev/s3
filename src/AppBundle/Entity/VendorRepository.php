<?php

namespace AppBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * VendorRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VendorRepository extends EntityRepository
{
    /**
     * Находит категорию по id или path
     *
     * @param integer|string $slug
     * @return AppBundle\Entity\Vendor
     */
    public function findBySlug($slug)
    {
        if(is_numeric($slug))
        {
            $category = $this->getEntityManager()->getRepository('AppBundle:Vendor')->find($slug);
        }
        else
        {
            $category = $this->getEntityManager()->getRepository('AppBundle:Vendor')->findOneBy(array('path'=>$slug));
        }
        return $category;
    }

    public function getEnabledProducts($id_vendor, $limit=null, $offset=null)
    {
        $repositoryProduct = $this->getEntityManager()->getRepository('AppBundle:Product');

        return $repositoryProduct->findBy(array(
            'id_vendor'=>$id_vendor,
            'disabled'=>false
        ), array(), $limit, $offset);
    }
    
    /**
     * Получить производителей с активными товарами
     */
    public function getVendorsWithActiveProducts()
    {
        $em = $this->getEntityManager();
        
        $dql = "SELECT v, p
                FROM AppBundle:Vendor v
                LEFT JOIN v.products p WITH p.disabled=false
                ORDER by v.title ASC";

        $q = $em->createQuery($dql);
        return $q->getResult();
    }
}
